<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="description" content="XMLShield - Privacy-first XML formatter. 100% local, zero dependencies, zero compromise.">
<title>XMLShield - Your Local XML Fortress</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Open Graph / Social Media -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://luisfemojica.github.io/xmlshield/">
<meta property="og:title" content="XMLShield - Your Local XML Fortress">
<meta property="og:description" content="Privacy-first XML formatter. 100% local, zero dependencies, zero compromise.">
<meta property="og:site_name" content="XMLShield">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="XMLShield - Your Local XML Fortress">
<meta name="twitter:description" content="Privacy-first XML formatter. 100% local, zero dependencies.">
<style>
  :root{
    --bg:#f4f4f4; --fg:#222; --panel:#fff; --border:#ccc; --btn:#0078ff; --btn2:#555; --err:#b00;
    --panel-dark:#1e1e1e; --bg-dark:#121212; --fg-dark:#ddd; --border-dark:#444;
    --green:#0aa15b; --purple:#6c30c8; --orange:#ff8c00; --blue:#667eea;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font: 15px system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(135deg, var(--blue) 0%, var(--purple) 100%);
    color: var(--fg);
    min-height: 100vh;
    padding: 0;
  }

  body.dark { 
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: var(--fg-dark); 
  }

  .container {
    max-width: 100%;
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: var(--bg);
  }

  body.dark .container { background: var(--bg-dark); }

  header {
    padding: 1.5rem;
    background: linear-gradient(135deg, var(--blue) 0%, var(--purple) 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  body.dark header {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
  }

  h2 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .controls {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 1rem;
  }

  button {
    padding: 0.6rem 1rem;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
  }

  button:hover { 
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }

  #fmt { background: var(--btn); color: #fff; }
  #min { background: var(--green); color: #fff; }
  #copy { background: var(--btn2); color: #fff; }
  #download { background: var(--orange); color: #fff; }
  #theme { background: #333; color: #fff; }
  #toggleView { background: var(--purple); color:#fff; }

  .options-row {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
    font-size: 0.9rem;
    padding: 0.5rem 0;
  }

  label {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    cursor: pointer;
    color: rgba(255,255,255,0.95);
  }

  label > input[type="number"] { 
    width: 64px;
    padding: 0.3rem;
    border-radius: 4px;
    border: 1px solid rgba(255,255,255,0.3);
    background: rgba(255,255,255,0.1);
    color: white;
    font-weight: 600;
  }

  input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  .sep { 
    margin: 0 0.5rem; 
    opacity: 0.5;
    color: rgba(255,255,255,0.6);
  }

  .kpi-row {
    display: flex;
    gap: 1rem;
    font-size: 0.9rem;
    color: rgba(255,255,255,0.9);
  }

  .kpi { 
    font-variant-numeric: tabular-nums;
    font-weight: 700;
    color: white;
  }

  #err { 
    color: #ffeb3b;
    font-weight: 700;
    background: rgba(255,0,0,0.2);
    padding: 0.5rem 1rem;
    border-radius: 6px;
    margin-top: 0.5rem;
    display: none;
  }

  #err:not(:empty) { display: block; }

  /* ============================================================
     LOADING OVERLAY
  ============================================================ */
  #loading-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.65);
    backdrop-filter: blur(3px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  #loading-overlay.show { display: flex; }

  .loading-box {
    background: var(--panel);
    border-radius: 14px;
    padding: 2rem 2.5rem;
    text-align: center;
    box-shadow: 0 12px 40px rgba(0,0,0,0.35);
    min-width: 260px;
  }
  body.dark .loading-box { background: var(--panel-dark); }

  .loading-spinner {
    width: 48px; height: 48px;
    border: 5px solid rgba(102,126,234,0.2);
    border-top-color: var(--blue);
    border-radius: 50%;
    animation: spin 0.9s linear infinite;
    margin: 0 auto 1.2rem;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-title {
    font-weight: 700;
    font-size: 1rem;
    color: var(--fg);
    margin-bottom: 0.35rem;
  }
  body.dark .loading-title { color: var(--fg-dark); }

  .loading-sub {
    font-size: 0.82rem;
    color: #888;
  }

  /* ============================================================
     MODAL DE CONFIRMACI√ìN
  ============================================================ */
  #confirm-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.65);
    backdrop-filter: blur(3px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
  }
  #confirm-modal.show { display: flex; }

  .confirm-box {
    background: var(--panel);
    border-radius: 14px;
    padding: 2rem;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 12px 40px rgba(0,0,0,0.4);
  }
  body.dark .confirm-box { background: var(--panel-dark); }

  .confirm-icon { font-size: 2.5rem; text-align: center; margin-bottom: 0.75rem; }

  .confirm-title {
    font-weight: 700;
    font-size: 1.05rem;
    color: var(--fg);
    margin-bottom: 0.75rem;
    text-align: center;
  }
  body.dark .confirm-title { color: var(--fg-dark); }

  .confirm-body {
    font-size: 0.88rem;
    color: #666;
    line-height: 1.6;
    margin-bottom: 1.5rem;
    text-align: center;
  }
  body.dark .confirm-body { color: #aaa; }

  .confirm-size-badge {
    display: inline-block;
    background: rgba(255,140,0,0.15);
    color: var(--orange);
    font-weight: 700;
    padding: 0.2rem 0.6rem;
    border-radius: 6px;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
  }

  .confirm-buttons { display: flex; gap: 0.75rem; }

  .btn-cancel-confirm {
    flex: 1; padding: 0.65rem 1rem;
    border-radius: 8px; border: 2px solid var(--border);
    background: transparent; color: var(--fg);
    font-weight: 600; cursor: pointer; transition: all 0.2s;
  }
  .btn-cancel-confirm:hover { background: var(--border); transform: translateY(-1px); }
  body.dark .btn-cancel-confirm { border-color: var(--border-dark); color: var(--fg-dark); }
  body.dark .btn-cancel-confirm:hover { background: var(--border-dark); }

  .btn-proceed-confirm {
    flex: 1; padding: 0.65rem 1rem;
    border-radius: 8px; border: none;
    background: var(--orange); color: #fff;
    font-weight: 700; cursor: pointer; transition: all 0.2s;
  }
  .btn-proceed-confirm:hover {
    background: #e07a00;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(255,140,0,0.4);
  }

    .workspace {
    display: grid;
    grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);  /* minmax evita que se compriman */
    gap: 0;
    flex: 1;
    overflow: hidden;
  }

    .panel {
    display: flex;
    flex-direction: column;
    background: var(--panel);
    border-right: 1px solid var(--border);
    height: calc(100vh - 250px);
    min-width: 0;  /* Permite que se encoja si necesario */
    max-width: 100%;  /* No excede su espacio */
  }

  body.dark .panel { 
    background: var(--panel-dark);
    border-right-color: var(--border-dark);
  }

  .panel:last-child { border-right: none; }

  .panel-header {
    padding: 0.8rem 1rem;
    background: var(--btn2);
    color: white;
    font-weight: 700;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid var(--border);
  }

  body.dark .panel-header {
    background: #1a1a1a;
    border-bottom-color: var(--border-dark);
  }

  textarea, .viewer {
    flex: 1;
    width: 100%;
    font: 14px ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    padding: 1rem;
    border: none;
    resize: none;
    outline: none;
    line-height: 1.6;
    overflow: auto;
  }

  #in {
    background: var(--panel);
    color: var(--fg);
  }

  body.dark #in {
    background: var(--panel-dark);
    color: var(--fg-dark);
  }

  #out {
    background: #fafafa;
    color: var(--fg);
  }

  body.dark #out {
    background: #0d0d0d;
    color: var(--fg-dark);
  }

  .viewer {
    white-space: pre;
    overflow: auto;
  }

  #outHtml {
    background: #fafafa;
  }

  body.dark #outHtml {
    background: #0d0d0d;
  }

  .drop {
    outline: 3px dashed var(--purple) !important;
    outline-offset: -8px;
    background: rgba(108, 48, 200, 0.05) !important;
  }

  /* Resaltado de sintaxis XML */
  .syntax { white-space: pre; }
  .syntax .tag     { color: #569CD6; }
  .syntax .attr    { color: #9CDCFE; }
  .syntax .value   { color: #CE9178; }
  .syntax .comment { color: #6A9955; }
  .syntax .symbol  { color: #D4D4D4; }
  body.dark .syntax .symbol { color: #BBBBBB; }

  @media (max-width: 968px) {
      .workspace {
    display: grid;
    grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);  /* minmax evita que se compriman */
    gap: 0;
    flex: 1;
    overflow: hidden;
  }

    .panel {
      border-right: none;
      border-bottom: 1px solid var(--border);
    }

    body.dark .panel {
      border-bottom-color: var(--border-dark);
    }

    .controls {
      flex-direction: column;
      align-items: stretch;
    }

    button {
      width: 100%;
      justify-content: center;
    }
  }


  /* ============================================
     FIX DEFINITIVO: Anchos fijos + Scroll
     ============================================ */

  /* Contenedor de salida con scroll independiente */
  #outHtml {
    height: 100%;
    width: 100%;
    overflow: auto;
    box-sizing: border-box;
  }

  /* Contenido que NO empuja otros paneles */
  #outHtml .syntax {
    display: block;
    width: max-content;  /* Se expande pero DENTRO de su contenedor */
    min-width: 100%;
    white-space: pre;
    height: auto;
    min-height: 100%;
  }

  /* Textarea de salida tambi√©n con ancho contenido */
  #out {
    min-width: 100%;
    width: max-content;
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h2>üõ°Ô∏è XMLShield ‚Ä¢ Your Local XML Fortress</h2>

    <div class="controls">
      <button id="fmt" title="Ctrl+Enter">‚ú® Formatear</button>
      <button id="min" title="Ctrl+M">üì¶ Minificar</button>
      <button id="toggleView" title="Ctrl+B">üëÅÔ∏è Vista: Resaltada</button>
      <button id="copy">üìã Copiar</button>
      <button id="download">üíæ Descargar</button>
      <button id="theme">üåô Modo oscuro</button>
    </div>

    <div class="options-row">
      <label>Sangr√≠a:
        <input id="indent" type="number" value="2" min="0" max="16">
      </label>
      <label><input id="tabs" type="checkbox"> Usar tabs</label>
      <label title="No elimina espacios significativos del documento al formatear">
        <input id="preserve" type="checkbox"> Conservar espacios (formato)
      </label>
      <span class="sep">|</span>
      <label title="No modifica espacios dentro de nodos de texto al minificar">
        <input id="keepTextWS" type="checkbox" checked> Conservar espacios en texto (minificar)
      </label>
      <label title="Quita espacios redundantes en los atributos, sin tocar el texto entre comillas">
        <input id="compactAttrs" type="checkbox" checked> Compactar atributos
      </label>
    </div>

    <div class="kpi-row">
      <span>üì• Entrada: <strong class="kpi" id="inSize">0</strong> bytes</span>
      <span class="sep">‚Ä¢</span>
      <span>üì§ Salida: <strong class="kpi" id="outSize">0</strong> bytes</span>
      <span class="sep">‚Ä¢</span>
      <span>üí∞ Ahorro: <strong class="kpi" id="savings">0%</strong></span>
    </div>

    <div id="err"></div>
  </header>

  <div class="workspace">
    <div class="panel">
      <div class="panel-header">üìù Entrada XML (arrastra archivo o pega texto)</div>
      <textarea id="in" placeholder="Pega aqu√≠ tu XML o arrastra un archivo .xml..."></textarea>
    </div>

    <div class="panel">
      <div class="panel-header">‚úÖ Salida Formateada</div>
      <textarea id="out" class="viewer" placeholder="El resultado aparecer√° aqu√≠..."></textarea>
      <div id="outHtml" class="viewer" style="display:none;"><div class="syntax"></div></div>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay">
  <div class="loading-box">
    <div class="loading-spinner"></div>
    <div class="loading-title" id="loading-title">Procesando XML...</div>
    <div class="loading-sub" id="loading-sub">Por favor espera</div>
  </div>
</div>

<!-- Modal de Confirmaci√≥n para archivos grandes -->
<div id="confirm-modal">
  <div class="confirm-box">
    <div class="confirm-icon">‚ö†Ô∏è</div>
    <div class="confirm-title">Archivo grande detectado</div>
    <div class="confirm-body">
      <span class="confirm-size-badge" id="confirm-size">0 MB</span><br>
      El procesamiento puede tardar varios segundos y consumir bastante memoria.<br><br>
      Para archivos muy grandes (+100MB) considera usar herramientas como <strong>xmllint</strong>.
    </div>
    <div class="confirm-buttons">
      <button class="btn-cancel-confirm" id="btn-cancel-confirm">‚úñ Cancelar</button>
      <button class="btn-proceed-confirm" id="btn-proceed-confirm">‚úî Continuar</button>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const inTa = $("#in"), outTa = $("#out"), outHtmlWrap = $("#outHtml"), outHtml = $("#outHtml .syntax");

  let highlightView = true;
  let lastOutputText = "";

  // --- Utilidades ---
  function bytesOf(str){ return new Blob([str]).size; }
  function updateKPIs(input, output){
    $("#inSize").textContent = bytesOf(input);
    $("#outSize").textContent = bytesOf(output);
    const i = bytesOf(input), o = bytesOf(output);
    const save = i ? Math.max(0, Math.round((1 - o / i) * 100)) : 0;
    $("#savings").textContent = isFinite(save) ? `${save}%` : "0%";
  }
  function showError(msg){ $("#err").textContent = msg || ""; console.error(msg); }
  function clearError(){ showError(""); }

  // --- Loading overlay ---
  function showLoading(title = "Procesando XML...", sub = "Por favor espera") {
    $("#loading-title").textContent = title;
    $("#loading-sub").textContent = sub;
    $("#loading-overlay").classList.add("show");
  }
  function hideLoading() {
    $("#loading-overlay").classList.remove("show");
  }

  // --- Modal de confirmaci√≥n (reemplaza confirm() nativo) ---
  function confirmLargeFile(mb) {
    return new Promise(resolve => {
      $("#confirm-size").textContent = mb.toFixed(1) + " MB";
      $("#confirm-modal").classList.add("show");
      $("#btn-proceed-confirm").onclick = () => {
        $("#confirm-modal").classList.remove("show");
        resolve(true);
      };
      $("#btn-cancel-confirm").onclick = () => {
        $("#confirm-modal").classList.remove("show");
        resolve(false);
      };
    });
  }

  // --- Verificaci√≥n de tama√±o ---
  // Retorna: false = cancelado, "large" = grande pero ok, true = normal
  async function checkFileSize(text) {
    const bytes = new Blob([text]).size;
    const mb = bytes / (1024 * 1024);
    if (bytes > 15 * 1024 * 1024) {
      setViewWithRenderOutput(false);// Forzar vista texto para evitar renderizado pesado en vista resaltada
    }
    if (bytes > 50 * 1024 * 1024) {
      const proceed = await confirmLargeFile(mb);
      return proceed ? true : false;
    }
    if (bytes > 10 * 1024 * 1024) return "large";
    return true;
  }

  async function checkFileSizeWithOutConfirm(text) {
    const bytes = new Blob([text]).size;
    const mb = bytes / (1024 * 1024);
    if (bytes > 15 * 1024 * 1024) {
      return "toolarge"
    }
    if (bytes > 10 * 1024 * 1024) return "large";
    return true;
  }

  function setView(highlight){
    highlightView = highlight;
    $("#toggleView").textContent = (highlightView ? "üëÅÔ∏è Vista: Resaltada" : "üëÅÔ∏è Vista: Texto");
    outHtmlWrap.style.display = highlightView ? "block" : "none";
    outTa.style.display       = highlightView ? "none"  : "block";
    renderOutput(lastOutputText);
  }

  function setViewWithRenderOutput(highlight) {
    highlightView = highlight;
    $("#toggleView").textContent = (highlightView ? "üëÅÔ∏è Vista: Resaltada" : "üëÅÔ∏è Vista: Texto");
    outHtmlWrap.style.display = highlightView ? "block" : "none";
    outTa.style.display = highlightView ? "none" : "block";
  }

  function renderOutput(text){
    lastOutputText = text || "";
    if (highlightView) {
      outHtml.innerHTML = highlightXML(lastOutputText);
    } else {
      outTa.value = lastOutputText;
    }
    updateKPIs(inTa.value, lastOutputText);
  }

  // --- Pretty print (indentaci√≥n real por √°rbol DOM) ---
  function prettyFormat(xml, indentChars = "  ", preserveWhitespace=false) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(xml, "application/xml");
    const err = doc.querySelector("parsererror");
    if (err) throw new Error("XML inv√°lido o mal formado.");

    let output = "";
    function walk(node, level) {
      const indent = indentChars.repeat(level);

      switch (node.nodeType) {
        case Node.DOCUMENT_NODE:
          for (let child of node.childNodes) walk(child, level);
          break;

        case Node.ELEMENT_NODE: {
          let openTag = "<" + node.nodeName;
          for (let attr of node.attributes) openTag += ` ${attr.name}="${attr.value}"`;

          if (node.childNodes.length === 0) {
            output += `${indent}${openTag}/>
`;
            return;
          }

          const hasElementChild = Array.from(node.childNodes).some(n => n.nodeType === Node.ELEMENT_NODE);
          const textChildren = Array.from(node.childNodes).filter(n => n.nodeType === Node.TEXT_NODE);
          const textJoined = textChildren.map(n => n.nodeValue).join("");
          const textNormalized = preserveWhitespace ? textJoined : textJoined.replace(/\s+/g, " ").trim();

          if (!hasElementChild && textNormalized.length > 0) {
            output += `${indent}${openTag}>${textNormalized}</${node.nodeName}>
`;
          } else {
            output += `${indent}${openTag}>
`;
            for (let child of node.childNodes) {
              walk(child, level + 1);
            }
            output += `${indent}</${node.nodeName}>
`;
          }
          break;
        }

        case Node.TEXT_NODE: {
          const val = preserveWhitespace ? node.nodeValue : node.nodeValue.replace(/\s+/g, " ").trim();
          if (val.length > 0) output += `${indent}${val}
`;
          break;
        }

        case Node.CDATA_SECTION_NODE:
          output += `${indent}<![CDATA[${node.nodeValue}]]>
`; break;

        case Node.COMMENT_NODE:
          output += `${indent}<!-- ${node.nodeValue.trim()} -->
`; break;

        case Node.PROCESSING_INSTRUCTION_NODE:
          output += `${indent}<?${node.nodeName} ${node.nodeValue}?>
`; break;
      }
    }

    walk(doc.documentElement, 0);
    return output;
  }

  // --- Recorrido recursivo de texto para minificado (sin TreeWalker) ---
  function normalizeTextNodesRec(node){
    for (let child = node.firstChild; child; child = child.nextSibling) {
      if (child.nodeType === Node.TEXT_NODE) {
        child.nodeValue = child.nodeValue.replace(/\s+/g, " ").trim();
      } else if (child.nodeType === Node.ELEMENT_NODE) {
        normalizeTextNodesRec(child);
      }
    }
  }

  // --- Minify (seguro, sin TreeWalker) ---
  function minify(xml, opts){
    const parser = new DOMParser();
    const doc = parser.parseFromString(xml, "application/xml");
    const err = doc.querySelector("parsererror");
    if (err) throw new Error("XML inv√°lido o mal formado.");

    if (!opts.keepTextWS) normalizeTextNodesRec(doc);

    let xmlOut = new XMLSerializer().serializeToString(doc);
    xmlOut = xmlOut.replace(/>\s+</g, "><").trim();

    if (opts.compactAttrs) {
      xmlOut = xmlOut.replace(/\s*=\s*/g, "=");
      xmlOut = xmlOut.replace(/<([^!\?][^>]+)>/g, (m, inner) => {
        let out = '';
        let inQuote = false, quoteChar = '';
        for (let i=0;i<inner.length;i++){
          const ch = inner[i];
          if ((ch === '"' || ch === "'") && !inQuote){ inQuote = true; quoteChar = ch; out += ch; continue; }
          if (inQuote && ch === quoteChar){ inQuote = false; quoteChar = ''; out += ch; continue; }
          if (!inQuote) {
            if (/\s/.test(ch)) {
              if (out[out.length-1] !== ' ') out += ' ';
            } else {
              out += ch;
            }
          } else {
            out += ch;
          }
        }
        return `<${out.trim()}>`;
      });
      xmlOut = xmlOut.replace(/\s+\/>/g, "/>");
    }

    return xmlOut;
  }

  // --- Resaltado de sintaxis XML (sin dependencias) ---
  function escapeHTML(s){
    return s
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;");
  }

  function highlightXML(xml) {
    let h = escapeHTML(xml);
    h = h.replace(/(&lt;!--[\s\S]*?--&gt;)/g, '<span class="comment">$1</span>');
    h = h.replace(/(&lt;\/?)([A-Za-z_][\w:\-.]*)([^\s\S]*?)(\/?\&gt;)/g,
      (m, lt, tag, attrs, gt) =>
        `<span class="symbol">${lt}</span><span class="tag">${tag}</span>${attrs}<span class="symbol">${gt}</span>`
    );
    h = h.replace(/([A-Za-z_][\w:\-.]*)=&quot;([\s\S]*?)&quot;/g,
      '<span class="attr">$1</span>=<span class="value">"$2"</span>'
    );
    return h;
  }

  // --- Eventos UI ---
  $("#fmt").onclick = async () => {
    clearError();
    const input = inTa.value;
    if (!input.trim()) { showError("‚ö†Ô∏è No hay XML para formatear."); return; }

    const sizeCheck = await checkFileSize(input);
    if (sizeCheck === false) { showError("‚ö†Ô∏è Operaci√≥n cancelada."); return; }

    const mb = (new Blob([input]).size / (1024*1024)).toFixed(1);
    showLoading("Formateando XML...", sizeCheck === "large" ? `Archivo de ${mb} MB ‚Äî esto puede tardar` : "Por favor espera");

    setTimeout(() => {
      try {
        const indent = +$("#indent").value || 0;
        const indentChars = $("#tabs").checked ? "\t" : " ".repeat(indent);
        const preserve = $("#preserve").checked;
        const output = prettyFormat(input, indentChars, preserve);
        renderOutput(output);
      } catch(e) {
        showError(e.message);
      } finally {
        hideLoading();
      }
    }, 80);
  };

  $("#min").onclick = async () => {
    clearError();
    const input = inTa.value;
    if (!input.trim()) { showError("‚ö†Ô∏è No hay XML para minificar."); return; }

    const sizeCheck = await checkFileSize(input);
    if (sizeCheck === false) { showError("‚ö†Ô∏è Operaci√≥n cancelada."); return; }

    const mb = (new Blob([input]).size / (1024*1024)).toFixed(1);
    showLoading("Minificando XML...", sizeCheck === "large" ? `Archivo de ${mb} MB ‚Äî esto puede tardar` : "Por favor espera");

    setTimeout(() => {
      try {
        const output = minify(input, {
          keepTextWS: $("#keepTextWS").checked,
          compactAttrs: $("#compactAttrs").checked
        });
        renderOutput(output);
      } catch(e) {
        showError(e.message);
      } finally {
        hideLoading();
      }
    }, 80);
  };

  $("#copy").onclick = async () => {
    try{
      await navigator.clipboard.writeText(lastOutputText || "");
      const btn = $("#copy");
      const label = btn.textContent;
      btn.textContent = "‚úÖ ¬°Copiado!";
      setTimeout(()=>btn.textContent = label, 1200);
    }catch{
      showError("No se pudo copiar al portapapeles (permiso del navegador).");
    }
  };

  $("#download").onclick = () => {
    if (!lastOutputText) {
      showError("No hay nada que descargar. Formatea o minifica primero.");
      return;
    }
    const blob = new Blob([lastOutputText], { type: 'application/xml' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
    a.href = url;
    a.download = `xml_formatted_${timestamp}.xml`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    const btn = $("#download");
    const label = btn.textContent;
    btn.textContent = "‚úÖ Descargado!";
    setTimeout(()=>btn.textContent = label, 1200);
  };

  $("#theme").onclick = () => {
    document.body.classList.toggle("dark");
    const isDark = document.body.classList.contains("dark");
    $("#theme").textContent = isDark ? "‚òÄÔ∏è Modo claro" : "üåô Modo oscuro";
  };

  $("#toggleView").onclick = async () => {
    const input = inTa.value;
    const sizeCheck = await checkFileSizeWithOutConfirm(input);
    if(sizeCheck === "toolarge") {
      showError("‚ö†Ô∏è El archivo es demasiado grande para la vista resaltada. Se mantendr√° en vista texto.");
      setViewWithRenderOutput(false);
      return;
    }
    const mb = (new Blob([input]).size / (1024 * 1024)).toFixed(1);
    showLoading("Cambiando de vista...", sizeCheck === "large" ? `Archivo de ${mb} MB ‚Äî esto puede tardar` : "Por favor espera");
    setTimeout(() => {
      try {
        setView(!highlightView)
      } catch (e) {
        showError(e.message);
      } finally {
        hideLoading();
      }
    }, 80);
  };

  // KPIs en vivo al escribir/pegar
  inTa.addEventListener("input", () => updateKPIs(inTa.value, lastOutputText));

  // Drag & drop de archivos XML al panel de entrada
  ;["dragenter","dragover"].forEach(ev => inTa.addEventListener(ev, e=>{
    e.preventDefault(); inTa.classList.add("drop");
  }));
  ;["dragleave","drop"].forEach(ev => inTa.addEventListener(ev, e=>{
    e.preventDefault(); inTa.classList.remove("drop");
  }));
  inTa.addEventListener("drop", async e => {
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if (!f) return;
    if (!/\.xml$/i.test(f.name)) { showError("‚ö†Ô∏è Arrastra un archivo .xml"); return; }

    // 1. Mostrar loading ANTES de leer el archivo
    const fileMB = (f.size / (1024 * 1024)).toFixed(1);
    const sub = f.size > 10 * 1024 * 1024
      ? `${f.name} ¬∑ ${fileMB} MB`
      : f.name;
    showLoading("Cargando archivo...", sub);

    try {
      // 2. Leer el archivo (async ‚Äî el loading ya es visible)
      const txt = await f.text();

      // 3. Verificar tama√±o ‚Äî puede mostrar el modal de confirmaci√≥n
      /*const sizeCheck = await checkFileSize(txt);
      if (sizeCheck === false) {
        showError("‚ö†Ô∏è Operaci√≥n cancelada.");
        return;
      }*/

      // 4. Cargar en el editor
      inTa.value = txt;
      updateKPIs(inTa.value, lastOutputText);
      clearError();
    } catch(err) {
      showError(`‚ùå Error al leer el archivo: ${err.message}`);
    } finally {
      hideLoading();
    }
  });

  // Atajos: Ctrl+Enter (Formatear), Ctrl+M (Minificar), Ctrl+B (Vista)
  document.addEventListener("keydown", e=>{
    if (e.ctrlKey && e.key === "Enter"){ e.preventDefault(); $("#fmt").click(); }
    if (e.ctrlKey && (e.key.toLowerCase() === "m")){ e.preventDefault(); $("#min").click(); }
    if (e.ctrlKey && (e.key.toLowerCase() === "b")){ e.preventDefault(); $("#toggleView").click(); }
  });

  // Vista por defecto: Resaltada
  setView(true);
  updateKPIs("", "");
})();
</script>
</body>
</html>